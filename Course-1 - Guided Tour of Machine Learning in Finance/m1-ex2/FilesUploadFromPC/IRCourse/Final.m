clear; clc;

P = transpose([103.8200	106.0400	118.4400	106.2800	101.1500	111.0600	106.2400	98.4900	110.8700]);

C = transpose([0.0000	0.0000	6.1250	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
105.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	4.8750	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	4.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	6.1250	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	4.8750	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	4.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	6.1250	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	104.8750	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	4.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	6.1250	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	4.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	6.1250	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	4.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	106.1250	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	4.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	104.5000	0.0000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	3.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	103.5000	0.0000	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	4.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	104.8750	0.0000	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	104.2500	0.0000	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	3.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	103.8750	0.0000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	4.5000
0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	0.0000	104.5000]);

T = datetime(transpose(["04-Sep-1996"
    "26-Sep-1996"
    "13-Oct-1996"
    "06-Nov-1996"
    "15-Nov-1996"
    "07-Dec-1996"
    "19-Jan-1997"
    "27-Feb-1997"
    "03-Mar-1997"
    "08-Mar-1997"
    "26-Mar-1997"
    "13-Apr-1997"
    "06-May-1997"
    "07-Jun-1997"
    "19-Jul-1997"
    "27-Aug-1997"
    "03-Sep-1997"
    "08-Sep-1997"
    "26-Sep-1997"
    "13-Oct-1997"
    "06-Nov-1997"
    "07-Dec-1997"
    "19-Jan-1998"
    "27-Feb-1998"
    "03-Mar-1998"
    "08-Mar-1998"
    "26-Mar-1998"
    "13-Apr-1998"
    "06-May-1998"
    "07-Jun-1998"
    "27-Aug-1998"
    "03-Sep-1998"
    "08-Sep-1998"
    "26-Sep-1998"
    "13-Oct-1998"
    "06-Nov-1998"
    "07-Dec-1998"
    "27-Feb-1999"
    "03-Mar-1999"
    "08-Mar-1999"
    "26-Mar-1999"
    "13-Apr-1999"
    "06-May-1999"
    "07-Jun-1999"
    "27-Aug-1999"
    "03-Sep-1999"
    "08-Sep-1999"
    "13-Oct-1999"
    "06-Nov-1999"
    "07-Dec-1999"
    "27-Feb-2000"
    "03-Mar-2000"
    "08-Mar-2000"
    "13-Apr-2000"
    "06-May-2000"
    "07-Jun-2000"
    "27-Aug-2000"
    "08-Sep-2000"
    "13-Oct-2000"
    "06-Nov-2000"
    "07-Dec-2000"
    "27-Feb-2001"
    "08-Mar-2001"
    "13-Apr-2001"
    "06-May-2001"
    "07-Jun-2001"
    "27-Aug-2001"
    "08-Sep-2001"
    "13-Oct-2001"
    "06-Nov-2001"
    "07-Dec-2001"
    "27-Feb-2002"
    "08-Mar-2002"
    "13-Apr-2002"
    "07-Jun-2002"
    "27-Aug-2002"
    "08-Sep-2002"
    "13-Oct-2002"
    "07-Dec-2002"
    "08-Mar-2003"
    "13-Apr-2003"
    "07-Jun-2003"
    "08-Sep-2003"
    "13-Oct-2003"
    "07-Dec-2003"
    "08-Mar-2004"
    "13-Apr-2004"
    "07-Jun-2004"
    "08-Sep-2004"
    "13-Oct-2004"
    "07-Dec-2004"
    "08-Mar-2005"
    "13-Apr-2005"
    "07-Jun-2005"
    "08-Sep-2005"
    "13-Oct-2005"
    "07-Dec-2005"
    "08-Mar-2006"
    "13-Apr-2006"
    "08-Sep-2006"
    "13-Oct-2006"
    "13-Apr-2007"
    "13-Oct-2007"
    "13-Apr-2008"
    "13-Oct-2008"]));

t = T(1:end-1);
tplus1 = T(2:end);

delta_T = (min(tplus1.Day, 30) + max(30 - t.Day, 0))/360 + (tplus1.Month - t.Month - 1)/12 + (tplus1.Year-t.Year);

Winv = diag(sqrt(delta_T));

Minv = tril(ones(104));

A = C*Minv*Winv;

Del = pinv(A) * (P - C*Minv*eye(104,1));

discount = Minv * (Winv*Del + eye(104,1));

C_port = zeros(104,1);
C_port(75) = 80;
C_port(96) = 100;
C_port(99) = 60;
C_port(104) = 250;
V = sum(C_port.*discount);

dV = transpose(C_port)*Minv*Winv*pinv(A);

h = -dV(1);

%%%

t = 1;
L01 = 0.05;
P01 = 1/(1 + L01*t);
k = 0.1;
sigma = 0.1;
r0 = 0.05;
gamma = sqrt(k^2 + 2*sigma^2);

theta = ( log(P01) + (2*(exp(gamma*t)-1)*r0) / ((gamma+k)*(exp(gamma*t)-1)+2*gamma) ) / ( (2*k/gamma^2) * log( (2*gamma*exp((gamma+k)*t/2)) / ((gamma+k)*(exp(gamma*t)-1)+2*gamma) ) );

%%%

T0 = 1;
T1 = 2;
k = 0.86;
theta = 0.08;
sigma = 0.01;

sd = k\sigma*( exp(-k*T0) - exp(-k*T1) ) * sqrt( (exp(2*k*T0) - 1)/(2*k) );
